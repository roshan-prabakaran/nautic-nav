{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Maritime Intelligence Dashboard</h1>
        <div class="last-updated">
            Last updated: <span id="last-updated"></span>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-ship"></i>
            </div>
            <div class="stat-content">
                <h3 id="total-vessels">--</h3>
                <p>Active Vessels</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <h3 id="active-alerts">--</h3>
                <p>Active Alerts</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-smog"></i>
            </div>
            <div class="stat-content">
                <h3 id="pollution-index">--</h3>
                <p>Pollution Index</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-thermometer-half"></i>
            </div>
            <div class="stat-content">
                <h3 id="water-temp">--°C</h3>
                <p>Water Temperature</p>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Vessel Traffic Overview</h3>
            </div>
            <div class="card-content">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <h3>Recent Alerts</h3>
            </div>
            <div class="card-content">
                <div id="alerts-list"></div>
            </div>
        </div>

        <div class="dashboard-card full-width">
            <div class="card-header">
                <h3>Live Vessel Map</h3>
            </div>
            <div class="card-content">
                <div id="map" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let map;
    let vesselMarkers = [];
    let trafficChart;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        initCharts();
        loadDashboardData();
        
        // Update data every 30 seconds
        setInterval(loadDashboardData, 30000);
    });

    function initMap() {
        map = L.map('map').setView([19.0760, 72.8777], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
    }

    function initCharts() {
        const ctx = document.getElementById('trafficChart').getContext('2d');
        trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Vessel Count',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function loadDashboardData() {
        // Load analytics data
        fetch('/api/analytics')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-vessels').textContent = data.total_vessels;
                document.getElementById('active-alerts').textContent = data.active_alerts;
                document.getElementById('pollution-index').textContent = data.avg_pollution;
                
                // Update chart
                trafficChart.data.labels = data.hours;
                trafficChart.data.datasets[0].data = data.vessel_traffic;
                trafficChart.update();
            });

        // Load vessel data for map
        fetch('/api/vessels')
            .then(response => response.json())
            .then(vessels => {
                updateVesselMap(vessels);
            });

        // Load environmental data
        fetch('/api/environment')
            .then(response => response.json())
            .then(data => {
                document.getElementById('water-temp').textContent = data.water_quality.temperature + '°C';
            });

        // Load alerts
        fetch('/api/alerts')
            .then(response => response.json())
            .then(alerts => {
                updateAlertsList(alerts);
            });

        // Update timestamp
        document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
    }

    function updateVesselMap(vessels) {
        // Clear existing markers
        vesselMarkers.forEach(marker => map.removeLayer(marker));
        vesselMarkers = [];

        // Add new markers
        vessels.forEach(vessel => {
            const icon = L.divIcon({
                className: 'vessel-marker',
                html: `<i class="fas fa-ship" style="color: ${getVesselColor(vessel.type)}"></i>`,
                iconSize: [20, 20]
            });

            const marker = L.marker([vessel.lat, vessel.lng], { icon })
                .bindPopup(`
                    <strong>${vessel.name}</strong><br>
                    Type: ${vessel.type}<br>
                    Speed: ${vessel.speed.toFixed(1)} knots<br>
                    Status: ${vessel.status}
                `);
            
            marker.addTo(map);
            vesselMarkers.push(marker);
        });
    }

    function getVesselColor(type) {
        const colors = {
            'Cargo': '#e74c3c',
            'Tanker': '#f39c12',
            'Fishing': '#27ae60',
            'Passenger': '#3498db',
            'Tug': '#9b59b6'
        };
        return colors[type] || '#95a5a6';
    }

    function updateAlertsList(alerts) {
        const alertsList = document.getElementById('alerts-list');
        alertsList.innerHTML = '';

        alerts.slice(0, 5).forEach(alert => {
            const alertElement = document.createElement('div');
            alertElement.className = `alert-item ${alert.severity.toLowerCase()}`;
            alertElement.innerHTML = `
                <div class="alert-content">
                    <strong>${alert.type}</strong>
                    <p>${alert.message}</p>
                    <small>${alert.timestamp} - Vessel ${alert.vessel_id}</small>
                </div>
                <div class="alert-severity ${alert.severity.toLowerCase()}">
                    ${alert.severity}
                </div>
            `;
            alertsList.appendChild(alertElement);
        });
    }
</script>
{% endblock %}
